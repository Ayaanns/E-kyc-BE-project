{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>Human Verification</h2>
    <div class="video-container">
        <video id="videoElement" width="640" height="480" autoplay></video>
        <canvas id="canvasElement" style="display:none;"></canvas>
    </div>
    <div id="status" class="mt-3">
        <p id="messageText">Initializing verification...</p>
        <p>Wave count: <span id="waveCount">0</span>/2</p>
        <p>Blink count: <span id="blinkCount">0</span>/3</p>
    </div>
</div>

<script>
const video = document.getElementById('videoElement');
const canvas = document.getElementById('canvasElement');
const ctx = canvas.getContext('2d');

// Initialize webcam
async function initCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    } catch (err) {
        console.error("Error accessing camera:", err);
    }
}

// Process frames
function processFrame() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        const frameData = canvas.toDataURL('image/jpeg');
        
        fetch('/human_verification/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                frame: frameData
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('messageText').textContent = data.message;
            document.getElementById('waveCount').textContent = data.wave_count;
            document.getElementById('blinkCount').textContent = data.blink_count;
            
            if (data.phase_complete) {
                // Handle completion
                window.location.href = '/success/';
            }
        })
        .catch(err => console.error("Error:", err));
    }
    requestAnimationFrame(processFrame);
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

initCamera().then(() => {
    processFrame();
});
</script>
{% endblock %}
